apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: alloy
  namespace: argocd
spec:
  project: default

  sources:
    - repoURL: https://grafana.github.io/helm-charts
      chart: alloy
      targetRevision: 1.4.0
      helm:
        values: |
          alloy:
            configMap:
              content: |
                // Discover Kubernetes pods
                discovery.kubernetes "pods" {
                  role = "pod"
                }

                // Relabel discovered pods
                discovery.relabel "pods" {
                  targets = discovery.kubernetes.pods.targets

                  rule {
                    source_labels = ["__meta_kubernetes_namespace"]
                    target_label  = "namespace"
                  }

                  rule {
                    source_labels = ["__meta_kubernetes_pod_name"]
                    target_label  = "pod"
                  }

                  rule {
                    source_labels = ["__meta_kubernetes_pod_container_name"]
                    target_label  = "container"
                  }

                  rule {
                    source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_name"]
                    target_label  = "app"
                  }

                  rule {
                    source_labels = ["__meta_kubernetes_pod_node_name"]
                    target_label  = "node"
                  }
                }

                // Collect logs from pods
                loki.source.kubernetes "pods" {
                  targets    = discovery.relabel.pods.output
                  forward_to = [loki.write.default.receiver]
                }

                // Write logs to Loki
                loki.write "default" {
                  endpoint {
                    url = "http://loki-write.loki.svc:3100/loki/api/v1/push"
                  }
                }

          controller:
            type: daemonset

          serviceAccount:
            create: true

    - repoURL: https://github.com/kahlstrm/infra.git
      targetRevision: main
      path: local-kubernetes/manifests/alloy

  destination:
    server: https://kubernetes.default.svc
    namespace: alloy

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
